<?xml version="1.0" encoding="UTF-8"?>
<job xmlns="urn:proactive:jobdescriptor:dev" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="urn:proactive:jobdescriptor:dev ../../src/scheduler/src/org/ow2/proactive/scheduler/common/xml/schemas/jobdescriptor/dev/schedulerjob.xsd" name="data-list" priority="normal" cancelJobOnError="true">
    <variables>

        <!-- wildcard : full file path regex to filter files to be listed -->
        <!-- wildcard can be : .* .*\\.log .*\\.txt .*file.* -->
        <variable name="wildcard" value=".*\\.log"/>

        <!-- recursive : if the copying mechanism will explore directories too -->
        <!-- recursive can be : true false -->
        <variable name="recursive" value="true"/>

        <!-- detailed : level of verbosity of the report -->
        <!-- detailed can be : true false -->
        <variable name="detailed" value="true"/>

        <!-- A protocol : protocol to be used to access endpoint A (remote) -->
        <!-- a.protocol can be: ftp ftps hdfs http https sftp webdav (supported by Apache VFS 2.0) -->
        <variable name="a.protocol" value="ftp"/>

        <!-- A server : server IP address (or name) to be used to access endpoint A (remote) -->
        <!-- a.server can be : 192.168.0.100 server.org ... -->
        <variable name="a.server" value="192.168.1.158"/>

        <!-- A port : port number to be used to access endpoint A (remote) -->
        <!-- a.port can be: 21 22 ... -->
        <variable name="a.port" value="21"/>

        <!-- A username : username to be used to access endpoint A (remote) -->
        <!-- a.username can be: user admin root ... -->
        <variable name="a.username" value="user"/>

        <!-- A password : password to be used to access endpoint A (remote) -->
        <!-- a.password can be: toto passwd ... -->
        <variable name="a.password" value="activeeon"/>

        <!-- A credpath : private key path to be used to access endpoint A (remote) -->
        <!-- a.credpath can be: /home/user/.ssh/id_rsa ... -->
        <variable name="a.credpath" value=""/>

        <!-- A credname : credential file name to be used that contains password to access endpoint A (remote), it must be in $HOME/.credentials -->
        <!-- a.credname can be: ftp-credentials-1.cred ... -->
        <variable name="a.credname" value=""/>

        <!-- A path : path to be used for endpoint A (remote) -->
        <!-- a.path can be: /remote-path/ ... -->
        <variable name="a.path" value="/.logs/"/>

    </variables>

	<taskFlow>
        <task name="list-files-task">
            <scriptExecutable>
                <script >
                    <code language="groovy">
                        <![CDATA[
import net.minidev.json.*
import org.apache.commons.vfs2.*
import org.apache.commons.vfs2.provider.sftp.*

def a_protocol = "${a.protocol}"
def a_server = "${a.server}"
def a_port =  "${a.port}"
def a_username =  "${a.username}"
def a_password =  "${a.password}"
def a_credname =  "${a.credname}"
def a_credpath =  "${a.credpath}"
def a_path =  "${a.path}"

def wildcard =  "${wildcard}"
def recursive =  "${recursive}".toBoolean()
def detailed =  "${detailed}".toBoolean()

println "Initializing parameters..."

a_password = getCredentials(a_password, a_credname)

def a_options = initializePrivateKeyMechanism(a_credpath)

println "Accessing A server..."

FileObject a_root = VFS.getManager().resolveFile(generateUrl(a_protocol, a_username, a_password, a_server, a_port), a_options)

println "Resolving A path..."

FileObject a_base = a_root.resolveFile(a_path)

println "Generating report..."

FileObject[] files = a_base.findFiles(new CustomFileSelector(wildcard, recursive))

def json = new JSONObject()
if (detailed) {
    def sourceFiles = new JSONObject()
    for (FileObject f : files)
        sourceFiles.put(f.name.path, getFileProperties(f))
    json.put("source_files", sourceFiles)
} else {
    def sourceFiles = new JSONArray()
    for (FileObject f : files)
        sourceFiles.add(f.name.path)
    json.put("source_files", sourceFiles)
}

result = json.toJSONString()

println "Report: $result"

a_root.close()

////////////////////////////////////////////////////////

def getFileProperties(FileObject f) {
    def fileJson = new JSONObject()
    fileJson.put("path", f.name.path)
    fileJson.put("baseName", f.name.baseName)
    fileJson.put("hidden", f.hidden)
    fileJson.put("readable", f.readable)
    fileJson.put("writeable", f.writeable)
    fileJson.put("contentOpen", f.contentOpen)
    return fileJson
}

def getCredentials(String password, String credname) {

    if (password != null && !password.isEmpty()) {
        println "Using provided password"
        return password
    }

    if (credname == null || credname.isEmpty())
        return null

    def credDir = new File(new File(System.getProperty("user.home")), ".credentials")
    def credFile = new File(credDir, credname)
    if (credFile.exists()) {
        println "Using provided credential file"
        return credFile.text
    } else {
        println "Could not find provided credential file"
        return null
    }

}

def generateUrl(String a_protocol, String a_username, String a_password, String a_server, String a_port) {
    return a_protocol + "://" + a_username + ":" + a_password + "@" + a_server + ":" + a_port
}

class CustomFileSelector implements FileSelector {
    private Boolean recursive
    private String wildcard
    public CustomFileSelector(String wildcard, Boolean recursive) {
        this.wildcard = wildcard
        this.recursive = recursive
    }
    @Override
    boolean includeFile(FileSelectInfo fileInfo) throws Exception {
        return fileInfo.file.getName().path.matches(wildcard)
    }
    @Override
    boolean traverseDescendents(FileSelectInfo fileInfo) throws Exception {
        return (fileInfo.depth==0?true:recursive)
    }
}

def FileSystemOptions initializePrivateKeyMechanism(def openSSHPrivateKeyPath) {
    FileSystemOptions fsOptions = new FileSystemOptions();
    SftpFileSystemConfigBuilder.getInstance().setStrictHostKeyChecking(fsOptions, "no");
    SftpFileSystemConfigBuilder.getInstance().setUserDirIsRoot(fsOptions, false);
    def files = [new File(openSSHPrivateKeyPath)] as File[]
    SftpFileSystemConfigBuilder.getInstance().setIdentities(fsOptions, files);
    return fsOptions
}

]]>
                    </code>
                </script>
            </scriptExecutable>
        </task>
    </taskFlow>
</job>

